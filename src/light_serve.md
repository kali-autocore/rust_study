# 红绿灯服务中心

# 需求分析

## 插件组件

1. 交通逻辑 -- 根据红绿灯组件配置，启动组件，并按照配置（起始状态及时长）运行红绿灯
2. 数据通信 -- 1. 通过HTTP请求，可更改红绿灯状态，比如，远程请求根据road_id,发送当前路口某红绿灯应属状态和时长，组件重新计算红绿灯状态 2. 红绿灯变更后，将红绿灯信息存储，以供其他应用使用（OBS车载）
3. 远程控制 -- 接收远程信号，停止组件
4. 状态上报 -- 插件间隔1s给远程控制平台发送一次红绿灯状态

## 平台功能

### 远程管理

1. 远程使能 -- 可远程和组件通信，通信方式http,通信内容： 1. 更新某处红绿灯状态 2. 启动或停止某插件
2. 配置更新 -- 更新插件管理的配置？
3. 状态上报 -- 上级是谁？


### 插件管理
1. 插件配置包含 红绿灯组件所在的IP和其实状态
2. 可查看当前正在运行的红绿灯组件状态，以及红绿灯当前状态
3. 可动态启动未在配置中的红绿灯组件，且将信息更新到配置文件中
4. 可停止远程插件运行，并更新配置中插件状态
   
   
## 简介

自的动驾驶在某路口的红绿灯信息通过红绿灯自行运行的规则和红绿灯控制中心的信息获取

1. 某路口红绿灯按照某一交通灯规则自行运行
2. 红绿灯管控中心发送某个路口红绿灯的转换规则
3. 本服务根据以上2个动作，得知当前路口红绿灯状态，并将信息通过zenoh发布出去

   
## 功能简介
1. 每隔1s，给红绿灯管控中心发送红绿灯信息
2. 接收红绿灯管控中心命令，调整红绿灯规则
3. 红绿灯信息变更后，更新zenoh中存储的红绿灯信息

## 实现逻辑
Tide+Zenoh
1. 启动服务
2. 读取红绿灯配置文件
3. 服务根据配置文件中红绿灯规则，得出当启动后的红绿灯信息，并发布到对应zenoh的path
4. 服务每隔1s发送红绿灯信息到红绿灯管控中心
5. 红绿灯管控中心发送了某路口新的红绿灯切换规则(如南北走向红绿灯变为红色，时间为60s)到本服务，那么按照收到的规则将当前红绿灯的信息进行调整，并发布到zenoh

## 配置文件内容
1. cross_rood_id 本服务将要应用的红绿灯路口ID，具体值来自于map中的路口ID
2. sn_light 南北方向红绿灯默认灯色，1 绿灯 2 红灯
3. interval 红绿灯切换时间间隔

## API

URL： {url}/rule_change
   
描述：  红绿灯管控中心发送红绿灯变动规则

请求类型： POST

请求内容：
|  字段   | 类型  | 描述  |
|  ----  | ----  | ----  |
| road_id  | string | 十字路口ID |
| light_name1             | i32    | 红绿灯名字以及时间|
| sn_time        | i32    | 南北方向灯剩余时间               |
| ew             | i32    | 东西方向红绿灯状态：1 绿 2 红 3 黄|
| ew_time        | i32    | 东西方向灯剩余时间               |
| timestamp      | i64    | 发送消息的时间戳                |

响应消息：
|  字段    | 类型    | 描述  |
|  ----   | ----    | ----  |
| status  | i32     | 处理状态，1 成功，-1 失败 |
| message | string  | 失败信息描述，成功为空|


## Zenoh 存储
Zenoh 存储 path/value

path： 某路口发布的红绿灯存储path，/light/detail/{road_id}

value: 该红绿灯的值，1 绿灯 2 红灯 3 黄灯





