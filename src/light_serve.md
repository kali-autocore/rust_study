# 需求分析

## 平台功能

### 远程管理

1. 远程使能 -- CloudViewer可以通过HTTP请求，控制本平台的插件状态
2. 配置更新 -- CloudViewer请求后，更新配置中插件状态
3. 状态上报 -- 上报插件状态给CloudViewer
   
### 插件管理

1. 配置读取 -- 启动平台时，根据插件配置，决定启动那些插件
2. 插件使能 -- 拥有启停某个插件的功能
   
## 插件

### 红绿灯插件

1. 交通逻辑 -- 根据红绿灯插件配置，启动插件，并按照配置规则（起始状态及时长）运行红绿灯
2. 数据通信 -- 1. 和CloudViewer通过HTTP通信，更改红绿灯状态和运行规则。2. 将当前的红绿灯信息存储到Zenoh，并将状态发布，以供OBS使用
3. 远程控制 -- 接收远程HTTP请求，更新红绿灯状态以及运行规则
4. 状态上报 -- 间隔1s给远程控制平台发送一次请求，上报红绿灯状态

### 其他插件

暂无


## 红绿灯插件简介

自的动驾驶在某路口的红绿灯信息通过红绿灯自行运行的规则和红绿灯控制中心的信息获取

1. 某路口红绿灯按照某一交通灯规则自行运行
2. 红绿灯管控中心发送某个路口红绿灯的转换规则
3. 本服务根据以上2个动作，得知当前路口红绿灯状态，并将信息通过zenoh发布出去

   
## 功能简介
1. 每隔1s，给红绿灯管控中心发送红绿灯信息
2. 接收红绿灯管控中心命令，调整红绿灯规则
3. 红绿灯信息变更后，更新zenoh中存储的红绿灯信息

## 实现逻辑
Tide+Zenoh
1. 启动服务
2. 读取红绿灯配置文件
3. 服务根据配置文件中红绿灯规则，得出当启动后的红绿灯信息，并发布到对应zenoh的path
4. 服务每隔1s发送红绿灯信息到红绿灯管控中心
5. 红绿灯管控中心发送了某路口新的红绿灯切换规则(如南北走向红绿灯变为红色，时间为60s)到本服务，那么按照收到的规则将当前红绿灯的信息进行调整，并发布到zenoh

## 配置文件内容
1. rood_id 本服务将要应用的红绿灯路口ID，具体值来自于map中的路口ID
2. sn_light 南北方向红绿灯默认灯色，1 绿灯 2 红灯
3. interval 红绿灯切换时间间隔

## API

URL： ip:port/rule_change
   
描述：  红绿灯管控中心发送红绿灯变动规则

请求类型： POST

请求内容：
|  字段   | 类型  | 描述  |
|  ----  | ----  | ----  |
| road_id  | string | 十字路口ID |
| light_id      | string    | 红绿灯名字|
| remain        | i32    | 剩余时间，若剩余时间为-1，则永不变灯   |
| color         | i32    | 1 红 2 绿 3 黄 0 灭灯|

响应消息：
|  字段    | 类型    | 描述  |
|  ----   | ----    | ----  |
| status  | i32     | 处理状态，1 成功，-1 失败 |
| message | string  | 失败信息描述，成功为空|


## Zenoh 存储
Zenoh 存储 path/value

path： 某路口发布的红绿灯存储path，/light/detail/{road_id}

value: 该红绿灯的值，1 红 2 绿 3 黄 0 灭灯





